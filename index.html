<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pre-Flight Trade Log</title>
    <style>
        :root {
            --bg: #0d1117;
            --card: #161b22;
            --text: #c9d1d9;
            --accent: #58a6ff;
            --green: #238636;
            --red: #da3633;
            --border: #30363d;
        }
        body { font-family: -apple-system, sans-serif; background-color: var(--bg); color: var(--text); padding: 10px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 500px; background: var(--card); padding: 15px; border-radius: 8px; border: 1px solid var(--border); box-sizing: border-box; }
        .grid-row { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 12px; }
        .input-group { margin-bottom: 12px; }
        label { display: block; margin-bottom: 4px; font-weight: bold; font-size: 0.85rem; color: #8b949e; }
        select, input[type="text"], button { width: 100%; padding: 12px; border-radius: 4px; border: 1px solid var(--border); background: #21262d; color: white; font-size: 0.9rem; box-sizing: border-box; }
        .checkbox-group { display: flex; align-items: center; gap: 10px; background: rgba(88, 166, 255, 0.05); padding: 10px; border-radius: 4px; margin-bottom: 8px; font-size: 0.85rem; border: 1px solid var(--border); }
        input[type="checkbox"] { width: 20px; height: 20px; flex-shrink: 0; }
        .btn-log { background: var(--green); cursor: pointer; border: none; font-weight: bold; margin-top: 5px; }
        .btn-utility { background: #30363d; font-size: 0.75rem; padding: 8px; cursor: pointer; border: 1px solid var(--border); color: white; }
        .remove-btn { color: var(--red); cursor: pointer; font-weight: bold; border: none; background: none; font-size: 1.1rem; padding: 0 5px; }
        
        #imgPreviewContainer { width: 100%; margin-top: 10px; border: 2px dashed var(--border); border-radius: 6px; text-align: center; padding: 10px; box-sizing: border-box; }
        #previewImg { max-width: 100%; max-height: 200px; display: none; margin-top: 10px; border-radius: 4px; }
        
        table { width: 100%; max-width: 600px; margin-top: 10px; border-collapse: collapse; font-size: 0.75rem; }
        th, td { padding: 8px; border: 1px solid var(--border); text-align: center; }
        th { background: #161b22; color: #8b949e; }
        .pos { color: var(--green); font-weight: bold; }
        .neg { color: var(--red); font-weight: bold; }
        .table-actions { width: 100%; max-width: 600px; display: flex; gap: 10px; margin-top: 25px; flex-wrap: wrap; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="container">
    <h3 style="margin: 0 0 15px 0; color: var(--accent); text-align: center;">Trade Pre-Flight</h3>

    <div class="grid-row">
        <div>
            <label>Entry Bar #</label>
            <select id="entryBar"></select>
        </div>
        <div>
            <label>Direction</label>
            <select id="direction">
                <option value="Bull">Bull</option>
                <option value="Bear">Bear</option>
            </select>
        </div>
    </div>

    <div class="input-group">
        <label>Entry Type</label>
        <select id="entryType">
            <option value="L2 Fade">Leg 2 Fade</option>
            <option value="L1 TRE">Leg 1 TRE</option>
        </select>
    </div>

    <div class="checkbox-group">
        <input type="checkbox" id="commit">
        <label for="commit" style="color:white; margin:0;">I commit to 1:1, no scale in</label>
    </div>

    <div class="checkbox-group" id="mistakeContainer">
        <input type="checkbox" id="mistakeCheck" onchange="toggleMistakeInput()">
        <label for="mistakeCheck" style="color:white; margin:0;">Execution Mistake</label>
    </div>
    
    <div id="mistakeInputGroup" class="input-group" style="display: none;">
        <input type="text" id="mistakeNote" placeholder="Note mistake...">
    </div>

    <div id="imgPreviewContainer">
        <span style="font-size: 0.8rem; color: #8b949e;">Click here & Paste Image (Ctrl+V)</span>
        <img id="previewImg" src="" alt="Preview">
    </div>

    <div class="grid-row" style="margin-top:10px;">
        <div><label>Outcome</label><select id="outcome"><option value="+1">+1 Win</option><option value="-1">-1 Loss</option></select></div>
        <div style="display: flex; align-items: flex-end;"><button class="btn-log" onclick="logTrade()">LOG TRADE</button></div>
    </div>
</div>

<div class="table-actions">
    <button class="btn-utility" onclick="copyTable()">Copy Text</button>
    <button class="btn-utility" onclick="downloadTxt()">Download .txt</button>
    <button class="btn-utility" style="background: var(--accent); border:none;" onclick="downloadMergedImage()">Download Chart + Log</button>
</div>

<table id="tradeTable">
    <thead>
        <tr><th>Bar</th><th>Type</th><th>Dir</th><th>Result</th><th>Notes</th><th>Del</th></tr>
    </thead>
    <tbody id="logBody"></tbody>
</table>

<canvas id="mergeCanvas"></canvas>

<script>
    let trades = [];
    const previewImg = document.getElementById('previewImg');

    function fillBars(id) {
        const sel = document.getElementById(id);
        for(let i=1; i<=81; i++) {
            let opt = document.createElement('option');
            opt.value = i; opt.innerHTML = i;
            sel.appendChild(opt);
        }
    }
    fillBars('entryBar');

    window.addEventListener('paste', e => {
        const items = e.clipboardData.items;
        for (let i = 0; i < items.length; i++) {
            if (items[i].type.indexOf('image') !== -1) {
                const reader = new FileReader();
                reader.onload = event => {
                    previewImg.src = event.target.result;
                    previewImg.style.display = 'block';
                };
                reader.readAsDataURL(items[i].getAsFile());
            }
        }
    });

    function toggleMistakeInput() {
        document.getElementById('mistakeInputGroup').style.display = document.getElementById('mistakeCheck').checked ? 'block' : 'none';
    }

    function logTrade() {
        if(!document.getElementById('commit').checked) return alert("Check commitment box!");
        
        const trade = {
            id: Date.now(),
            bar: parseInt(document.getElementById('entryBar').value),
            type: document.getElementById('entryType').value,
            dir: document.getElementById('direction').value,
            out: document.getElementById('outcome').value,
            note: document.getElementById('mistakeCheck').checked ? `Mistake: ${document.getElementById('mistakeNote').value || 'Unspecified'}` : '-'
        };

        trades.push(trade);
        trades.sort((a, b) => a.bar - b.bar);
        renderTable();

        document.getElementById('commit').checked = false;
        document.getElementById('mistakeCheck').checked = false;
        document.getElementById('mistakeNote').value = '';
        toggleMistakeInput();
    }

    function renderTable() {
        const tbody = document.getElementById('logBody');
        tbody.innerHTML = '';
        trades.forEach(t => {
            const row = tbody.insertRow();
            row.innerHTML = `
                <td>${t.bar}</td>
                <td>${t.type}</td>
                <td>${t.dir}</td>
                <td class="${t.out.includes('+1') ? 'pos' : 'neg'}">${t.out}</td>
                <td>${t.note}</td>
                <td><button class="remove-btn" onclick="removeTrade(${t.id})">Ã—</button></td>
            `;
        });
    }

    function removeTrade(id) {
        trades = trades.filter(t => t.id !== id);
        renderTable();
    }

    function getFormattedDate() {
        const d = new Date();
        const mm = String(d.getMonth() + 1).padStart(2, '0');
        const dd = String(d.getDate()).padStart(2, '0');
        const yyyy = d.getFullYear();
        return `${mm}_${dd}_${yyyy}`;
    }

    function getTableDataText() {
        let text = `TRADING LOG - ${getFormattedDate()}\nBAR | TYPE | DIR | RESULT | NOTES\n------------------------------------\n`;
        trades.forEach(t => {
            text += `${t.bar.toString().padStart(2, ' ')}  | ${t.type.padEnd(8, ' ')} | ${t.dir.padEnd(4, ' ')} | ${t.out.padEnd(6, ' ')} | ${t.note}\n`;
        });
        return text;
    }

    function copyTable() {
        navigator.clipboard.writeText(getTableDataText()).then(() => alert("Copied!"));
    }

    function downloadTxt() {
        const blob = new Blob([getTableDataText()], { type: 'text/plain' });
        const a = document.createElement('a');
        a.download = `Trades_${getFormattedDate()}.txt`;
        a.href = URL.createObjectURL(blob);
        a.click();
    }

    function downloadMergedImage() {
        if (!previewImg.src) return alert("Paste image first!");
        const canvas = document.getElementById('mergeCanvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.src = previewImg.src;
        img.onload = () => {
            const logLines = getTableDataText().split('\n');
            const rowHeight = 30;
            canvas.width = img.width;
            canvas.height = img.height + (logLines.length * rowHeight) + 60;
            ctx.fillStyle = "white";
            ctx.fillRect(0, 0, canvas.width, canvas.height);
            ctx.drawImage(img, 0, 0);
            ctx.fillStyle = "black";
            ctx.font = "bold 20px Courier New";
            let y = img.height + 40;
            logLines.forEach(line => { ctx.fillText(line, 40, y); y += rowHeight; });
            const link = document.createElement('a');
            link.download = `Trades_${getFormattedDate()}.png`;
            link.href = canvas.toDataURL();
            link.click();
        };
    }
</script>
</body>
</html>
